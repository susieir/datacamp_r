---
title: "Introduction to data visualization with ggplot2"
output: html_notebook
---

## Chapter 1 - Introduction
### Section 1 - Introduction

#### Exploratory vs. explanatory analysis
- Exploratory - confirm and analyse
- Explanatory - inform and persuade

### Loading dataset
```{r}
library(MASS)
mammals
```

#### A Scatter plot
```{r}
ggplot(mammals, aes(x = body, y = brain)) +
  geom_point()
```

#### Explore with a linear model
- Poor choice, since a few extreme values have a large influence
```{r}
ggplot(mammals, aes(x = body, y = brain)) +
  geom_point(alpha = 0.6) +
  stat_smooth(
    method = "lm",
    color = "red",
    se = FALSE
  )
```
#### Explore - fine tuning
- Log transformation allows for a better fit
```{r}
ggplot(mammals, aes(x = body, y = brain)) +
  geom_point(alpha = 0.6) +
  coord_fixed() +
  scale_x_log10() +
  scale_y_log10() +
  stat_smooth(
    method = "lm",
    color = "#C42126",
    se = FALSE,
    size = 1
  )
```

#### Anscombe's plots
- Example of how different datasets can lead to the same linear plots despite different relationships

#### Using factors in scatter plots
- Wrap `factor()` around the variable and the axis will adjust to show only the relevant points

### Section 2 - The grammar of graphics
- Build on an underlying grammar

#### The grammar of graphics
- Plotting framework
- Leland Wilkinson 1999
- 2 principles
  - Graphics = distinct layers of grammatical elements
  - Meaningful plots through aesthetic mappings
  
#### The three essential grammatical elements
- Data - the data-set being plotted
- Aesthetics - the scales onto which we *map* our data
- Geometrics - the visual elements used for our plot
- Themes - all non-data ink
- Statistics - representations of our data to aid understanding
- Coordinates - the space on which the data will be plotted
- Facets - plotting small multiples

#### Understanding variables
- can use color inside aes
- can use size inside aes
- can use shape inside aes - data must be categorical

### Section 3 - ggplot2 layers
#### ggplot2 package
- The grammar of graphics is implemented in R
- Two key concepts:
  1. Layer grammatical elements
  2. Aesthetic mappings
  
#### Data
- Bottom layer
- Using - iris dataset
```{r}
iris
```

#### Aesthetics
- Next layer
- Tells us scales we should map our data to
- Establish aesthetic mappings
- `sepal.length = x`
- `sepal.width = y`

#### Geometrics
- Allows us to choose how the plot will look
```{r}
g <- ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width)) +
  geom_jitter()
g
```
#### Themes
- Controls all non-data ink on plot
```{r}
g <- g +
  labs(x = "Sepal Length (cm)", y = "Sepal Width (cm)") +
  theme_classic()
g
```
#### Adding geometries
- geom_point() - adds points (as in a scatter plot)
- geom_smooth() - adds a smooth trend curve
- These can be labelled

#### Changing one geom or every geom
- Mapping an aesthetic to data variable inside the call to `ggplot()` will change *all* the geoms
- It is also possible to make changes to *individual* geoms by passing arguments to the `geom_*()` functions
- E.g. geom_point(alpha = 0.4)

#### Saving plots as variables
- Plots can be saved as variables, which can be added to later on using the `+` operator. This is useful if you want to make multiple related plots from a common base 


## Chapter 2 - Aesthetics
### Section 1 - Visible aesthetics
#### Mapping onto the X and Y axes
```{r}
ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +
  geom_point()
```

- Mapping sepal length onto X aesthetic, sepal width onto y aesthetic
- species can be mapped onto the color aesthetic
- Map aesthetics in the `aes()` function
- Could call in the `geom_*()` function
  - Typically only necessarily if all layers should *not* inherit the same aesthetics
  - Or if mixing different data sources
- Try to keep data and ggplot aesthetics in the same function definition 
- Typical visible aesthetics
  - x
  - y
  - fill - fill color
  - color - color of points, outlines of other geoms
  - size - area of radius of points, thinkness of lines
  - alpha - transparency
  - linetype - line dash pattern
  - labels - text on a plot or axes, categorical data only
  - shape - point shape, categorical data only
  
- Function as both aes and attributes

#### All about aesthetics: color, shape and size
- Aesthetics you can consider within aes:
  - `x`
  - `y`
  - `color`
  - `fill`
  - `size`
  - `alpha`
  - `labels`
  - `shape` - 1 (empty circles)
- Common convention - you don't name the `x` and `y` arguments to `aes()` as they always come first, but you do name the other arguments

#### All about aesthetics: color vs. fill
- `color` typically changes the *outline* of a geom and the `fill` aesthetic changes the inside
- `geom_point()` is an exception - you use `color` (not `fill`) for the point color, but some shapes have special behaviour
- The default `geom_point()` uses `shape = 19`, a solid circle
- An alternative is `shape = 21` - a circle that allows you to use *both* `fill` for the inside and `color` for the outside 

### Section 2 - Using attributes
- Attributes - how something looks
- All visible aesthetics also exist as attributes
- Attributes always called in the geom layer
```{r}
ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width)) +
  geom_point(color = 'red')
```

- e.g. Color - attribute set using color argument
-  size
- shape

- You can use all the aesthetics as attributes (but as attributes, they are not mapped to variables)
- E.g. Setting labels to row names `labels = rownames(series)`

### Section 3 - Modifying aesthetics
#### Positions
- Adjustment for overlapping
  - `identity` - the most straightforward position, default - value in df is where it is positioned in the plot
  - `dodge` - for bars this unstacks bars and sets side-by-side
  - `stack`
  - `fill`
  - `jitter`
  - `jitterdodge`
  - `nudge`
  
```{r}
ggplot(iris, aes(x = Sepal.Length,
                 y = Sepal.Width,
                 color = Species)) +
  geom_point(position = "identity")
```
- Too much overplotting to distinguish the points
- Need to add some random noise on the x and y axes to see regions of high density - jittering
```{r}
ggplot(iris, aes(x = Sepal.Length,
                 y = Sepal.Width,
                 color = Species)) +
  geom_point(position = "jitter")
```

- Each position type can be used as an argument or accessed as a function
```{r}
posn_j <- position_jitter(0.1)

ggplot(iris, aes(x = Sepal.Length,
                 y = Sepal.Width,
                 color = Species)) +
  geom_point(position = posn_j)
```
- Benefits of using as function
   - Can set arguments for the position - such as how much random noise should be added
   - Allows for consistency across plots and layers
- Applies for all other position attributes

#### Scale functions
- Each of the aesthetics is a scale that we map the data onto
- We can access all scales with the `scale_` functions
- The second part specifies which scale we want to modify
- All aesthetics have an associated scale function
  - `scale_x_*()`
  - `scale_y_*()`
  - `scale_color_*()` (also `scale_colour_*()`)
  - `scale_fill_*()`
  - `scale_shape_*()`
  - `scale_linetype_*()`
  - `scale_size_*()`
- Scale functions - must be appropriate for the type of data we are using
  - **`scale_x_continuous()`**
  - `scale_y_*()`
  - **`scale_color_discrete()`**
    - Alternatively, `scale_colour_*()`
  - `scale_fill_*()`
  - `scale_shape_*()`
  - `scale_linetype_*()`
  - `scale_linetype_*()`
  - `scale_size_*()`

#### `scale_*_*()
```{r}
ggplot(iris, aes(x = Sepal.Length,
                 y = Sepal.Width,
                 color = Species)) +
  geom_point(position = 'jitter') +
  scale_x_continuous("Sepal Length") +
  scale_color_discrete("Species")
```

#### The limits argument
- Describe the scales range
```{r}
ggplot(iris, aes(x = Sepal.Length,
                 y = Sepal.Width,
                 color = Species)) +
  geom_point(position = 'jitter') +
  scale_x_continuous("Sepal Length",
                     limits = c(2,8)) +
  scale_color_discrete("Species")
```
#### The breaks argument
- Control tickmarks positions
```{r}
ggplot(iris, aes(x = Sepal.Length,
                 y = Sepal.Width,
                 color = Species)) +
  geom_point(position = 'jitter') +
  scale_x_continuous("Sepal Length",
                     limits = c(2,8),
                     breaks = seq(2, 8, 3)) +
  scale_color_discrete("Species")
```
#### The expand argument
- Numerical factor of length 2, giving a multiplicative, additive constant, used to expand the range of the scales so that there is a small gap between the data and the axes
```{r}
ggplot(iris, aes(x = Sepal.Length,
                 y = Sepal.Width,
                 color = Species)) +
  geom_point(position = 'jitter') +
  scale_x_continuous("Sepal Length",
                     limits = c(2,8),
                     breaks = seq(2, 8, 3),
                     expand = c(0,0)) +
  scale_color_discrete("Species")
```
#### The labels argument
```{r}
ggplot(iris, aes(x = Sepal.Length,
                 y = Sepal.Width,
                 color = Species)) +
  geom_point(position = 'jitter') +
  scale_x_continuous("Sepal Length",
                     limits = c(2,8),
                     breaks = seq(2, 8, 3),
                     expand = c(0,0),
                     labels = c("Setosa", "Versicolor", "Virginica")) +
  scale_color_discrete("Species")
```

#### labs()
- To quickly change the axis labels
```{r}
ggplot(iris, aes(x = Sepal.Length,
                 y = Sepal.Width,
                 color = Species)) +
  geom_point(position = 'jitter') +
  labs(x = "Sepal Length", y = "Sepal Width", color = "Species")
```

#### Updating aesthetic labels
- `scale_color_manual()` 
  - Defines the properties of the color scale (i.e. axis)
  - The first argument sets the legend title
  - `values` is a named vector of colors to use
  
#### Setting a dummy aesthetic
- You can make univariate plots in `ggplot2` but you will need to add a fake y axis by mapping `y` to zero
- When setting y-axis limits, you can specify the limits as separate arguments, or as a single numeric vector. That is, `ylim(lo, hi)` or `ylim(c(lo, hi))`

### Section 4: Aesthetics best practices
#### Which aesthetics?
- Some clear guidelines to follow
- Jacques Bertin - The Semiology of Graphics, 1967
- William Cleveland
  - The Elements of Graphing Data, 1985
  - Visualizing Data, 1993
  
#### Form follows function
- Function depends on audience
- Primary:
  - Accurate and efficient representations
- Secondary:
  - Visually appealing, beautiful plots
  
- Guiding principles:
  - Never - misrepresent or obscure data, or confuse viewers with complexity
  - Always - consider the audience and purpose of every plot
  
#### Extracting information from data
- Encoding numbers and text into visual medium

#### The best choices for aesthetics
- Efficient - provides a faster overview than numeric summaries
- Accurate - minimises information loss

#### Choices for mapping continuous variables
![Plotting continuous variables](Plotting_continuous_variables.png)
- Color good for categorical variables
- Watch out for overplotting
  - Could adjust position
  
## Chapter 3 - Geometrics
- Determines how the plot actually looks
### Section 1 - Scatter plots
- Currently 48 geometries

#### Common plot types
- Scatter plots
  - points, jitter, abline, smooth, count
  - x and y essential
  - optional - alpha, color, fill, shape, size, stroke  
  
#### Scatter plots
- Each geom can accept specific aesthetic mappings, e.g. geom_point()
```{r}
ggplot(iris, aes(x = Sepal.Length,
                 y = Sepal.Width)) +
  geom_point()
```
### Geom-specific aesthetic mappings
```{r}
# Same as plot below
ggplot(iris, aes(x = Sepal.Length,
                 y = Sepal.Width)) +
  geom_point()

# Same as plot above
ggplot(iris, aes(x = Sepal.Length,
                 y = Sepal.Width)) +
  geom_point(aes(color = Species))

```

- You can control aesthetic mappings of each layer independently

#### Summary statistics
```{r}
library('dplyr')
iris %>%
  group_by(Species) %>%
  summarise_all(mean) -> iris.summary # Summary statistics
```

- ggplot2 can take care of stats for us
```{r}
ggplot(iris, aes(x = Sepal.Length,
                 y = Sepal.Width,
                 col = Species)) +
  # Inherits both data and aes from ggplot
  geom_point() +
  # Different data, but inherited aes
  geom_point(data = iris.summary, shape = 15, size = 5)
```

![Shape attribute values](shape_attribute_values.png)
 - 21 - 25 have shape and fill that can be controlled independently

```{r}
ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, col = Species)) +
  geom_point() + 
  geom_point(data = iris.summary, shape = 21, size = 5, fill = "black", stroke = 2)
```
  - Note - not fair to plot the mean without some indication of sd - further info in the stats section
  
#### Position = "jitter"
```{r}
ggplot(iris,
       aes(x = Sepal.Length,
           y = Sepal.Width,
           col = Species)) +
  geom_point(position = "jitter")
```

- `geom_jitter()` a short-cut to `geom_point(position = "jitter")`
- Combine jittering with alpha-blending if necessary
- Hollow circules also help (`shape = 1`)
  - If use this, not also necessary to use alpha blending
- Jitter can be a geom itself (`geom_jitter()`), an argument in geom_point() (`position = jitter`), or a position function (i.e. `position_jitter()`)  

### Section 2 - Histograms
#### Common plot types
- Bar plots
  - Histogram, bar, col, errorbar

#### Histograms
- A plot of binned values
  - i.e. a statistical function
```{r}
ggplot(iris, aes(x = Sepal.Width)) + geom_histogram()
```
- Geom is associated with a particular statistic - 'stat_bin()'
  - Default = 30
```{r}
ggplot(iris, aes(x = Sepal.Width)) + 
  geom_histogram(binwidth = 0.1)
```

- Always set meaningful bin widths for your data
- No spaces between bars
- x-labels are between bars

#### Re-position tick marks
```{r}
ggplot(iris, aes(x = Sepal.Width)) + 
  geom_histogram(binwidth = 0.1,
                 ceneter = 0.05)
```

#### Different species
```{r}
ggplot(iris, aes(x = Sepal.Width, fill = Species)) +
  geom_histogram(binwidth = 0.1,
                 ceneter = 0.05,
                 position = 'stack')
```
- Difficult to see if bars overlapping or stacked - default is stacked
- Can also `dodge` bars - offset

```{r}
ggplot(iris, aes(x = Sepal.Width, fill = Species)) +
  geom_histogram(binwidth = 0.1,
                 ceneter = 0.05,
                 position = 'dodge')
```

- `position = "fill"`
  - Fills to represent the proportion of all observations
  
```{r}
ggplot(iris, aes(x = Sepal.Width,
                 fill = Species)) +
  geom_histogram(binwidth = 0.1,
                 center = 0.05,
                 position = 'fill')
```
- An internal variable called `density`, can be accessed by using the `..` notation, i.e. `..density..`
- Plotting this variable will show the relative frequency, which is the height times the width of each bin (i.e. normalises the histogram)

### Section 3 - Bar plots
# Bar plots, with a categorical x-axis
- Use `geom_bar()` or `geom_col()`
  - `geom_bar()` 
    - stat = "count"
    - counts the number of cases at each x position
  - `geom_col()`
    - stat = "identity"
    - plots actual values
- All positions from before are available
- Two types
  - Absolute counts
  - Distributions

#### Habits of mammals
```{r}
str(msleep)
ggplot(msleep, aes(vore)) +
  geom_bar()
```

- Default value - bin set for stat argument
- Useful for quick visual output

#### Plotting distributions instead of absolute counts
```{r}
# Calculate descriptive statistics
library(tidyr)
iris_summ_long <- iris %>%
  select(Species, Sepal.Width) %>%
  gather(key, value, -Species) %>%
  group_by(Species) %>%
  summarise(avg = mean(value),
            stdev = sd(value))

iris_summ_long
```

